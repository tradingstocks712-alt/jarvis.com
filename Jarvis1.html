<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jarvis AI Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.1/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: #e0e0e0;
            height: 100dvh; /* Dynamic viewport height for mobile */
            overflow: hidden;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.6); 
        }
        ::-webkit-scrollbar-thumb {
            background: #00D9FF; 
            border-radius: 4px;
        }
        #matrixCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.15;
        }
        .container {
            display: flex;
            flex-direction: column;
            height: 100dvh;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: rgba(0, 217, 255, 0.1);
            border-bottom: 2px solid #00D9FF;
            padding: 20px;
            text-align: center;
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.3);
            position: relative;
        }

        .header h1 {
            color: #00D9FF;
            font-size: 2em;
            text-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
            letter-spacing: 2px;
        }

        .header img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #00D9FF;
            margin-bottom: 10px;
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.4);
            animation: pulseLogo 2s infinite ease-in-out;
        }

        @keyframes pulseLogo {
            0% { transform: scale(1); box-shadow: 0 0 20px rgba(0, 217, 255, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 35px rgba(0, 217, 255, 0.7); }
            100% { transform: scale(1); box-shadow: 0 0 20px rgba(0, 217, 255, 0.4); }
        }

        .header p {
            color: #a0aec0;
            margin-top: 5px;
        }
        
        .clear-btn {
            position: absolute;
            right: 20px;
            top: 20px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #fca5a5;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s;
        }

        .clear-btn:hover {
            background: rgba(239, 68, 68, 0.4);
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
        }

        .stop-btn {
            position: absolute;
            right: 20px;
            top: 65px;
            background: rgba(255, 165, 0, 0.2);
            border: 1px solid #ffa500;
            color: #ffd700;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s;
        }

        .stop-btn:hover {
            background: rgba(255, 165, 0, 0.4);
            box-shadow: 0 0 15px rgba(255, 165, 0, 0.4);
        }
        
        .settings-btn {
            position: absolute;
            left: 20px;
            top: 20px;
            background: rgba(0, 217, 255, 0.2);
            border: 1px solid #00D9FF;
            color: #00D9FF;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s;
        }

        .settings-btn:hover {
            background: rgba(0, 217, 255, 0.4);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.4);
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: rgba(15, 23, 42, 0.6);
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 15px;
            position: relative;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            border: 1px solid #4a5568;
        }

        .message.jarvis .message-bubble {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 2px solid #00D9FF;
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.2);
        }

        .message-sender {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .message.user .message-sender {
            color: #cbd5e0;
        }

        .message.jarvis .message-sender {
            color: #00D9FF;
            text-shadow: 0 0 5px rgba(0, 217, 255, 0.5);
        }

        .message-text {
            line-height: 1.5;
            font-size: 1.00em;
        }

        .message-text p {
            margin-bottom: 0.20em;
        }

        .message-text pre {
            background: #0d1117;
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
            border: 1px solid #30363d;
        }

        .message-text code {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
        }
        
        .message-text :not(pre) > code {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            color: #00D9FF;
        }

        .tools-used {
            margin-top: 10px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .tool-badge {
            background: rgba(0, 217, 255, 0.2);
            color: #00D9FF;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            border: 1px solid #00D9FF;
        }

        .audio-player {
            margin-top: 10px;
            width: 100%;
        }

        .audio-player audio {
            width: 100%;
            height: 32px;
        }

        .input-container {
            background: rgba(15, 23, 42, 0.9);
            border-top: 2px solid #00D9FF;
            padding: 20px;
            box-shadow: 0 -5px 20px rgba(0, 217, 255, 0.2);
        }

        .input-area {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-field {
            flex: 1;
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid #334155;
            border-radius: 25px;
            padding: 12px 20px;
            color: #e0e0e0;
            font-size: 1em;
            transition: all 0.3s;
            resize: none;
            height: 52px;
        }

        .input-field:focus {
            outline: none;
            border-color: #00D9FF;
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.3);
        }

        .btn {
            background: linear-gradient(135deg, #00D9FF 0%, #0099cc 100%);
            border: none;
            color: #0a0e27;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.3s;
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 25px rgba(0, 217, 255, 0.6);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .voice-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #cbd5e0;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .voice-toggle input[type="checkbox"] {
            cursor: pointer;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            color: #00D9FF;
            padding: 20px;
        }

        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(0, 217, 255, 0.3);
            border-top: 3px solid #00D9FF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .api-key-setup {
            background: rgba(255, 193, 7, 0.1);
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin: 20px;
            color: #ffc107;
        }

        .api-key-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .api-key-input input {
            flex: 1;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #ffc107;
            border-radius: 5px;
            padding: 8px 12px;
            color: #e0e0e0;
        }

        .visualizer-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 30px;
            gap: 4px;
            margin-top: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .visualizer-container.active {
            opacity: 1;
        }

        .bar {
            width: 6px;
            background: #00D9FF;
            height: 5px;
            border-radius: 3px;
            animation: wave 1s infinite ease-in-out;
            box-shadow: 0 0 5px rgba(0, 217, 255, 0.5);
        }

        @keyframes wave {
            0%, 100% { height: 5px; opacity: 0.5; }
            50% { height: 25px; opacity: 1; }
        }

        .mic-btn {
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid #00D9FF;
            color: #00D9FF;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.2em;
            margin-right: 10px;
        }

        .mic-btn:hover {
            background: rgba(0, 217, 255, 0.3);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.4);
        }

        .mic-btn.listening {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #ef4444;
            animation: pulseRed 1.5s infinite;
        }

        @keyframes pulseRed {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .header {
                padding: 10px;
            }
            .header h1 {
                font-size: 1.5em;
            }
            .header img {
                width: 60px;
                height: 60px;
            }
            .message-bubble {
                max-width: 85%;
                padding: 10px 15px;
            }
            .input-container {
                padding: 10px;
            }
            .btn {
                padding: 10px 20px;
            }
            .mic-btn {
                width: 45px;
                height: 45px;
            }
            .settings-btn, .clear-btn, .stop-btn {
                padding: 5px 10px;
                font-size: 0.75em;
            }
            .stop-btn {
                top: 55px;
            }
        }
    </style>
</head>
<body>
    <canvas id="matrixCanvas"></canvas>
    <div class="container">
        <div class="header">
            <button class="settings-btn" onclick="toggleSetup()">‚öôÔ∏è Settings</button>
            <img src="https://i.makeagif.com/media/9-11-2016/jbjBG9.gif" alt="Jarvis Logo">
            
            <h1>‚ö°JARVIS</h1>
        <p>Advanced AI Assistant (2026)</p>
            <div id="visualizer" class="visualizer-container">
                <!-- Bars injected by JS -->
            </div>
            <button class="clear-btn" onclick="clearChat()">üóëÔ∏è Clear Memory</button>
            <button class="stop-btn" onclick="stopSpeaking()">üõë Stop Talking</button>
        </div>

        <div id="apiKeySetup" class="api-key-setup" style="display: none;">
            <strong>‚ö†Ô∏è Optional Upgrade:</strong> Enter Google Gemini or OpenRouter API key.
            <div class="api-key-input">
                <input type="password" id="apiKeyInput" placeholder="Enter your API key (cwk-...)">
                <button class="btn" onclick="saveApiKey()">Save</button>
            </div>
            <small>Get your API key from: <a href="https://aistudio.google.com/app/api-keys" target="_blank" style="color: #076474;">CodeWords Dashboard</a></small>
        </div>

        <div class="chat-container" id="chatContainer">
            <!-- Messages will appear here -->
        </div>

        <div class="input-container">
            <div class="voice-toggle">
                <input type="checkbox" id="voiceOutput" checked>
                <label for="voiceOutput">üîä Enable Voice Response</label>
            </div>
            <div class="input-area">
                <button class="mic-btn" id="micBtn" onclick="toggleVoiceInput()">üéôÔ∏è</button>
                <textarea 
                    id="messageInput" 
                    class="input-field" 
                    placeholder="Ask Jarvis anything..."
                    rows="1"
                    onkeypress="handleKeyPress(event)"
                ></textarea>
                <button class="btn" onclick="sendMessage()" id="sendBtn">Send</button>
            </div>
        </div>
    </div>

    <script>
        let apiKey = localStorage.getItem('jarvis_api_key_v3') || "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";
        let conversationHistory = [];
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // Ensure all links open in new tab
        document.getElementById('chatContainer').addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (link && link.href) {
                e.preventDefault();
                window.open(link.href, '_blank');
            }
        });

        // Check if API key exists
        if (apiKey && apiKey !== "free-mode") {
            document.getElementById('apiKeyInput').value = apiKey;
        }

        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (key.startsWith('cwk-') || key.startsWith('AIza') || key.startsWith('sk-or-')) {
                localStorage.setItem('jarvis_api_key_v3', key);
                apiKey = key;
                document.getElementById('apiKeySetup').style.display = 'none';
                addMessage('jarvis', 'API key saved successfully. Jarvis is now online!', []);
            } else {
                alert('Invalid API key. It should start with "AIza", "sk-or-", or "cwk-"');
            }
        }

        function toggleSetup() {
            const setup = document.getElementById('apiKeySetup');
            setup.style.display = setup.style.display === 'none' ? 'block' : 'none';
        }

        function clearChat() {
            if(confirm('Clear conversation history?')) {
                conversationHistory = [];
                document.getElementById('chatContainer').innerHTML = '';
                addMessage('jarvis', 'Memory wiped. Ready for new instructions.', []);
            }
        }

        function stopSpeaking() {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                document.getElementById('visualizer').classList.remove('active');
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Sound Effects
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'send') {
                osc.frequency.setValueAtTime(400, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
            } else if (type === 'receive') {
                osc.frequency.setValueAtTime(800, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 0.15);
                gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15);
            }
            
            osc.start();
            osc.stop(audioCtx.currentTime + 0.2);
        }

        // Voice Input
        function toggleVoiceInput() {
            if (!('webkitSpeechRecognition' in window)) {
                alert('Voice input is not supported in this browser.');
                return;
            }
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'en-US';
            recognition.onstart = () => document.getElementById('micBtn').classList.add('listening');
            recognition.onend = () => document.getElementById('micBtn').classList.remove('listening');
            recognition.onresult = (event) => {
                const text = event.results[0][0].transcript;
                document.getElementById('messageInput').value = text;
                document.getElementById('voiceOutput').checked = true;
                sendMessage();
            };
            recognition.start();
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const query = input.value.trim();
            
            if (!query) return;

            // Stop any current speech immediately when user sends a new message
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }

            // Add user message to chat
            addMessage('user', query, []);
            conversationHistory.push({ role: 'User', content: query });
            playSound('send');
            input.value = '';

            // Show loading
            const loadingId = addLoading();

            // Check for image generation request
            const imageRegex = /^(?:draw)\s+(.+)|^(?:create|generate|make|show)\s+(?:an?\s+)?(?:image|picture|photo|art|sketch)\s+(?:of\s+)?(.+)|^(?:image|picture|photo)\s+of\s+(.+)/i;
            const match = query.match(imageRegex);

            if (match) {
                const imagePrompt = match[1] || match[2] || match[3];
                const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(imagePrompt)}`;
                
                const img = new Image();
                img.onload = () => {
                    removeLoading(loadingId);
                    addMessage('jarvis', `Here is the image you requested:`, ['image_gen'], null, imageUrl);
                    conversationHistory.push({ role: 'Jarvis', content: `[Generated image: ${imageUrl}]` });
                    if (document.getElementById('voiceOutput').checked) {
                        speak("Here is the image you requested");
                    }
                };
                img.onerror = () => {
                    removeLoading(loadingId);
                    addMessage('jarvis', "Sorry, I couldn't generate that image.", []);
                };
                img.src = imageUrl;
                return;
            }

            // Check for creator question
            if (query.toLowerCase().match(/who\s+(create|created|made|built|designed)\s+you/i)) {
                removeLoading(loadingId);
                const text = "Shashank Bollu and 8th grade who is studing in CMR International School";
                conversationHistory.push({ role: 'Jarvis', content: text });
                addMessage('jarvis', text, [], null);
                if (document.getElementById('voiceOutput').checked) {
                    speak(text);
                }
                return;
            }

            // Check for weather request
            const weatherMatch = query.match(/(?:weather|temperature) in (.+)/i);
            if (weatherMatch) {
                const city = weatherMatch[1];
                try {
                    const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=en&format=json`);
                    const geoData = await geoRes.json();
                    
                    if (geoData.results) {
                        const { latitude, longitude, name, country } = geoData.results[0];
                        const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,wind_speed_10m`);
                        const weatherData = await weatherRes.json();
                        const current = weatherData.current;
                        const text = `Current weather in ${name}, ${country}: ${current.temperature_2m}¬∞C, Wind: ${current.wind_speed_10m} km/h.`;
                        
                        removeLoading(loadingId);
                        addMessage('jarvis', text, ['web_search']);
                        conversationHistory.push({ role: 'Jarvis', content: text });
                        if (document.getElementById('voiceOutput').checked) speak(text);
                        return;
                    }
                } catch (e) {
                    console.warn("Weather fetch failed, falling back to AI");
                }
            }

            // Check for open youtube
            if (query.toLowerCase().includes('open youtube')) {
                removeLoading(loadingId);
                const text = "Opening YouTube for you.";
                addMessage('jarvis', text, []);
                conversationHistory.push({ role: 'Jarvis', content: text });
                if (document.getElementById('voiceOutput').checked) speak(text);
                window.open('https://www.youtube.com', '_blank');
                return;
            }

            // Check for open instagram
            if (query.toLowerCase().includes('open instagram')) {
                removeLoading(loadingId);
                const text = "Opening Instagram for you.";
                addMessage('jarvis', text, []);
                conversationHistory.push({ role: 'Jarvis', content: text });
                if (document.getElementById('voiceOutput').checked) speak(text);
                window.open('https://www.instagram.com', '_blank');
                return;
            }

            // Check for open facebook
            if (query.toLowerCase().includes('open facebook') || query.toLowerCase().includes('open face book')) {
                removeLoading(loadingId);
                const text = "Opening Facebook for you.";
                addMessage('jarvis', text, []);
                conversationHistory.push({ role: 'Jarvis', content: text });
                if (document.getElementById('voiceOutput').checked) speak(text);
                window.open('https://www.facebook.com', '_blank');
                return;
            }

            // Check for time
            if (query.toLowerCase().includes('what time is it') || query.toLowerCase().includes('current time')) {
                removeLoading(loadingId);
                const time = new Date().toLocaleTimeString();
                const text = `The current time is ${time}.`;
                addMessage('jarvis', text, []);
                conversationHistory.push({ role: 'Jarvis', content: text });
                if (document.getElementById('voiceOutput').checked) speak(text);
                return;
            }

            // Check for calculator
            if (query.toLowerCase().startsWith('calculate ')) {
                try {
                    const expression = query.toLowerCase().replace('calculate ', '').replace(/x/g, '*').replace(/[^0-9+\-*/().\s]/g, '');
                    const result = eval(expression);
                    removeLoading(loadingId);
                    const text = `The result is ${result}.`;
                    addMessage('jarvis', text, []);
                    conversationHistory.push({ role: 'Jarvis', content: text });
                    if (document.getElementById('voiceOutput').checked) speak(text);
                    return;
                } catch (e) {
                    // Fall through to AI if calculation fails
                }
            }

            try {
                const voiceOutput = document.getElementById('voiceOutput').checked;
                
                // Inject current date/time context dynamically
                const now = new Date().toString();
                
                // Build prompt with history (limit to last 10 messages)
                const history = conversationHistory.slice(-10).map(msg => `${msg.role}: ${msg.content}`).join('\n');
                const prompt = `System: Current date and time is ${now}. You are Jarvis, an advanced AI assistant. You are multilingual and can understand and reply in any language the user speaks. You answer concisely and use Markdown for formatting code and lists.\n${history}\nJarvis:`;

                let text = "";
                let success = false;
                
                // Try Primary API if configured
                if (apiKey && (apiKey.startsWith('AIza') || apiKey.startsWith('sk-or-'))) {
                    try {
                        if (apiKey.startsWith('AIza')) {
                            // Use Google Gemini API
                            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    contents: [{ parts: [{ text: prompt }] }]
                                })
                            });
                            if (!response.ok) throw new Error(`Gemini API Error: ${response.status}`);
                            const data = await response.json();
                            text = data.candidates[0].content.parts[0].text;
                        } else {
                            // Use OpenRouter API
                            const messages = [
                                { role: "system", content: `Current date and time is ${now}. You are Jarvis, an advanced AI assistant. You answer concisely and use Markdown for formatting code and lists.` },
                                ...conversationHistory.map(msg => ({ 
                                    role: msg.role === 'User' ? 'user' : 'assistant', 
                                    content: msg.content 
                                }))
                            ];
                            const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                                method: "POST",
                                headers: {
                                    "Authorization": `Bearer ${apiKey}`,
                                    "Content-Type": "application/json",
                                    "HTTP-Referer": window.location.href,
                                    "X-Title": "Jarvis AI"
                                },
                                body: JSON.stringify({
                                    "model": "google/gemini-1.5-flash",
                                    "messages": messages
                                })
                            });
                            if (!response.ok) throw new Error(`OpenRouter API Error: ${response.status}`);
                            const data = await response.json();
                            text = data.choices[0].message.content;
                        }
                        success = true;
                    } catch (e) {
                        console.warn("Primary API failed, switching to backup:", e);
                    }
                }

                // Fallback to Pollinations (Free LLM) if primary failed or not configured
                if (!success) {
                    // Call Pollinations.ai (Free LLM)
                    let response = await fetch(`https://text.pollinations.ai/${encodeURIComponent(prompt)}`);
                    
                    // Retry logic for 429 (Too Many Requests)
                    if (response.status === 429) {
                        await new Promise(r => setTimeout(r, 2000));
                        response = await fetch(`https://text.pollinations.ai/${encodeURIComponent(prompt)}`);
                    }

                    if (!response.ok) throw new Error(`Pollinations API Error: ${response.status}`);
                    text = await response.text();
                }

                removeLoading(loadingId);

                conversationHistory.push({ role: 'Jarvis', content: text });
                addMessage('jarvis', text, [], null);
                playSound('receive');
                if (voiceOutput) {
                    speak(text);
                }

            } catch (error) {
                removeLoading(loadingId);
                addMessage('jarvis', `Connection error: ${error.message}`, []);
            }
        }

        function addMessage(sender, text, tools = [], audioUrl = null, imageUrl = null) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            let toolsHtml = '';
            if (tools && tools.length > 0) {
                toolsHtml = '<div class="tools-used">' + 
                    tools.map(tool => {
                        const icon = tool === 'web_search' ? 'üîç' : (tool === 'image_gen' ? 'üé®' : 'üåê');
                        const name = tool === 'web_search' ? 'Web Search' : (tool === 'image_gen' ? 'Image Generation' : 'Web Scraping');
                        return `<span class="tool-badge">${icon} ${name}</span>`;
                    }).join('') +
                    '</div>';
            }

            let audioHtml = '';
            if (audioUrl) {
                audioHtml = `<div class="audio-player">
                    <audio controls autoplay>
                        <source src="${audioUrl}" type="audio/mpeg">
                    </audio>
                </div>`;
            }

            let imageHtml = '';
            if (imageUrl) {
                imageHtml = `<div class="image-container" style="margin-top: 10px;">
                    <img src="${imageUrl}" alt="Generated Image" style="max-width: 100%; border-radius: 10px; border: 2px solid #00D9FF;">
                </div>`;
            }

            // Parse Markdown for Jarvis messages, escape HTML for user messages to prevent XSS
            const contentHtml = sender === 'jarvis' ? marked.parse(text) : escapeHtml(text);

            messageDiv.innerHTML = `
                <div class="message-bubble">
                    <div class="message-sender">${sender === 'user' ? 'You' : 'Jarvis'}</div>
                    <div class="message-text">${contentHtml}</div>
                    ${imageHtml}
                    ${toolsHtml}
                    ${audioHtml}
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;

            // Highlight code blocks
            if (sender === 'jarvis') {
                messageDiv.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                    // Add copy button
                    const pre = block.parentElement;
                    const copyBtn = document.createElement('button');
                    copyBtn.textContent = 'Copy';
                    copyBtn.style.cssText = 'position: absolute; top: 5px; right: 5px; background: rgba(0, 217, 255, 0.2); border: 1px solid #00D9FF; color: #00D9FF; border-radius: 4px; padding: 2px 8px; cursor: pointer; font-size: 0.8em;';
                    copyBtn.onclick = () => {
                        navigator.clipboard.writeText(block.textContent);
                        copyBtn.textContent = 'Copied!';
                        setTimeout(() => copyBtn.textContent = 'Copy', 2000);
                    };
                    pre.style.position = 'relative';
                    pre.appendChild(copyBtn);
                });
            }
        }

        function addLoading() {
            const container = document.getElementById('chatContainer');
            const loadingDiv = document.createElement('div');
            const id = 'loading-' + Date.now();
            loadingDiv.id = id;
            loadingDiv.className = 'loading';
            loadingDiv.innerHTML = `
                <div class="loading-spinner"></div>
                <span>Jarvis is thinking...</span>
            `;
            container.appendChild(loadingDiv);
            container.scrollTop = container.scrollHeight;
            return id;
        }

        function removeLoading(id) {
            const loadingDiv = document.getElementById(id);
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        let voices = [];
        function loadVoices() {
            voices = window.speechSynthesis.getVoices();
        }
        window.speechSynthesis.onvoiceschanged = loadVoices;
        loadVoices();

        // Initialize Visualizer Bars
        const visualizer = document.getElementById('visualizer');
        for(let i=0; i<10; i++) {
            const bar = document.createElement('div');
            bar.className = 'bar';
            bar.style.animationDelay = `${Math.random() * 0.5}s`;
            visualizer.appendChild(bar);
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                const voices = window.speechSynthesis.getVoices();
                if (voices.length === 0) loadVoices();

                // Try to find a male voice
                const maleVoice = voices.find(v => v.name.includes('Microsoft David')) || 
                                  voices.find(v => v.name.includes('Google US English')) || 
                                  voices.find(v => v.name.toLowerCase().includes('male'));
                if (maleVoice) utterance.voice = maleVoice;
                utterance.pitch = 0.9;
                
                utterance.onstart = () => document.getElementById('visualizer').classList.add('active');
                utterance.onend = () => document.getElementById('visualizer').classList.remove('active');
                
                window.speechSynthesis.speak(utterance);
            }
        }

        // Welcome message
        window.addEventListener('load', () => {
            if (apiKey) {
                addMessage('jarvis', 'Greetings. I am Jarvis, your advanced AI assistant. How may I assist you today?', []);
            }
        });

        // Matrix Rain Effect
        const canvas = document.getElementById('matrixCanvas');
        const ctx = canvas.getContext('2d');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const katakana = '„Ç¢„Ç°„Ç´„Çµ„Çø„Éä„Éè„Éû„É§„É£„É©„ÉØ„Ç¨„Ç∂„ÉÄ„Éê„Éë„Ç§„Ç£„Ç≠„Ç∑„ÉÅ„Éã„Éí„Éü„É™„É∞„ÇÆ„Ç∏„ÉÇ„Éì„Éî„Ç¶„Ç•„ÇØ„Çπ„ÉÑ„Éå„Éï„É†„É¶„É•„É´„Ç∞„Ç∫„Éñ„ÉÖ„Éó„Ç®„Çß„Ç±„Çª„ÉÜ„Éç„Éò„É°„É¨„É±„Ç≤„Çº„Éá„Éô„Éö„Ç™„Ç©„Ç≥„ÇΩ„Éà„Éé„Éõ„É¢„É®„Éß„É≠„É≤„Ç¥„Çæ„Éâ„Éú„Éù„É¥„ÉÉ„É≥';
        const latin = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        const nums = '0123456789';
        const alphabet = katakana + latin + nums;

        const fontSize = 16;
        const columns = canvas.width/fontSize;
        const drops = Array(Math.floor(columns)).fill(1);

        function drawMatrix() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#00D9FF';
            ctx.font = fontSize + 'px monospace';

            for(let i = 0; i < drops.length; i++) {
                const text = alphabet.charAt(Math.floor(Math.random() * alphabet.length));
                ctx.fillText(text, i*fontSize, drops[i]*fontSize);
                if(drops[i]*fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
                drops[i]++;
            }
        }
        setInterval(drawMatrix, 30);
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
    </script>
</body>
</html>